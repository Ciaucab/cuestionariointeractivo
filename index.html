<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Evaluaci√≥n de Combustible</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            padding: 30px;
            margin: 20px 0;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.2rem;
        }
        
        h2 {
            color: #3498db;
            margin: 25px 0 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .intro {
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.6;
            color: #555;
        }
        
        .bluetooth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 10px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 10px;
        }
        
        .connected {
            background-color: #2ecc71;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 10px 0;
        }
        
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .question {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 600px) {
            .options {
                grid-template-columns: 1fr;
            }
        }
        
        .option {
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option:hover {
            background-color: #dee2e6;
        }
        
        .selected {
            background-color: #3498db;
            color: white;
        }
        
        .correct {
            background-color: #2ecc71;
            color: white;
        }
        
        .incorrect {
            background-color: #e74c3c;
            color: white;
        }
        
        .results {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border-radius: 10px;
            background-color: #e8f4fc;
            display: none;
        }
        
        .score {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .bomba-score {
            color: #3498db;
        }
        
        .inyector-score {
            color: #f39c12;
        }
        
        .system-status {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
        }
        
        .success {
            background-color: #2ecc71;
            color: white;
        }
        
        .failure {
            background-color: #e74c3c;
            color: white;
        }
        
        .send-command {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 20px;
            background-color: #3498db;
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            margin: 25px 0 15px;
        }
        
        .category-icon {
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema de Evaluaci√≥n de Combustible</h1>
        
        <p class="intro">
            Este cuestionario eval√∫a tus conocimientos sobre el circuito de la bomba de combustible y el circuito del inyector. 
            Debes obtener al menos 8 respuestas correctas en cada categor√≠a para activar el sistema. 
            ¬°Conecta v√≠a Bluetooth al finalizar para enviar el comando de activaci√≥n!
        </p>
        
        <div class="bluetooth-section">
            <h2>Conexi√≥n Bluetooth</h2>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionText">Desconectado del ESP32</span>
            </div>
            <button id="connectBtn" onclick="connectBluetooth()">Conectar con ESP32</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
        
        <div id="quizContainer">
            <!-- Las preguntas se insertar√°n aqu√≠ mediante JavaScript -->
        </div>
        
        <div class="results" id="resultsSection">
            <h2>Resultados del Cuestionario</h2>
            
            <div class="score bomba-score">
                Bomba de Combustible: <span id="bombaScore">0</span>/10 correctas
            </div>
            
            <div class="score inyector-score">
                Inyectores: <span id="inyectorScore">0</span>/10 correctas
            </div>
            
            <div class="system-status" id="systemStatus">
                <!-- Se mostrar√° el estado del sistema -->
            </div>
            
            <div class="send-command">
                <button id="sendCommandBtn" onclick="sendCommand()" disabled>
                    Enviar Comando al ESP32
                </button>
            </div>
        </div>
    </div>

    <script>
        // Preguntas y respuestas
        const questions = [
            // Bomba de combustible (10 preguntas)
            {
                category: "bomba",
                question: "¬øCu√°l es la funci√≥n principal de la bomba de combustible?",
                options: [
                    "Enfriar el motor",
                    "Bombear combustible al sistema",
                    "Generar electricidad",
                    "Filtrar el aire"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øD√≥nde se ubica t√≠picamente la bomba de combustible en veh√≠culos modernos?",
                options: [
                    "En el motor",
                    "En el tanque de combustible",
                    "En el compartimiento del filtro de aire",
                    "Cerca del radiador"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© se√±al controla generalmente el funcionamiento de la bomba de combustible?",
                options: [
                    "Se√±al mec√°nica del cig√ºe√±al",
                    "Se√±al electr√≥nica de la ECU",
                    "Presi√≥n de aceite",
                    "Temperatura del refrigerante"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© tipo de bomba de combustible es m√°s com√∫n en veh√≠culos modernos?",
                options: [
                    "Bomba de paletas",
                    "Bomba de engranajes",
                    "Bomba el√©ctrica",
                    "Bomba de diafragma"
                ],
                answer: 2
            },
            {
                category: "bomba",
                question: "¬øQu√© problema puede causar una bomba de combustible defectuosa?",
                options: [
                    "Sobrecalentamiento del motor",
                    "Falta de potencia y fallos en el encendido",
                    "Desgaste prematuro de neum√°ticos",
                    "Problemas en el sistema de frenos"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© mide el sensor de presi√≥n de combustible?",
                options: [
                    "La temperatura del combustible",
                    "La presi√≥n en el riel de combustible",
                    "El flujo de combustible",
                    "El nivel de combustible en el tanque"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© elemento protege a la bomba de combustible de impurezas?",
                options: [
                    "El regulador de presi√≥n",
                    "El filtro de combustible",
                    "El sensor de ox√≠geno",
                    "La v√°lvula de liberaci√≥n de presi√≥n"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© sucede cuando falla el relay de la bomba de combustible?",
                options: [
                    "El motor acelera bruscamente",
                    "La bomba no recibe energ√≠a y el motor no arranca",
                    "El sistema de aire acondicionado deja de funcionar",
                    "Se enciende la luz de aceite"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øQu√© indica un zumbido excesivo de la bomba de combustible?",
                options: [
                    "Que est√° funcionando correctamente",
                    "Posible obstrucci√≥n en el sistema o bomba defectuosa",
                    "Que el tanque est√° lleno",
                    "Que la bater√≠a est√° baja"
                ],
                answer: 1
            },
            {
                category: "bomba",
                question: "¬øPor qu√© es importante mantener el tanque de combustible con algo de combustible?",
                options: [
                    "Para mejorar la tracci√≥n del veh√≠culo",
                    "Para evitar que la bomba se sobrecaliente y se da√±e",
                    "Para reducir la evaporaci√≥n del combustible",
                    "Para mantener el equilibrio del veh√≠culo"
                ],
                answer: 1
            },
            
            // Inyectores (10 preguntas)
            {
                category: "inyector",
                question: "¬øQu√© funci√≥n cumple el inyector en el sistema de combustible?",
                options: [
                    "Bombear combustible",
                    "Pulverizar combustible en la c√°mara de combusti√≥n",
                    "Filtrar impurezas",
                    "Regular la presi√≥n de combustible"
                ],
                answer: 1
            },
            {
                category: "inyector",
                question: "¬øQu√© se√±ales controlan la apertura de los inyectores?",
                options: [
                    "Se√±ales mec√°nicas",
                    "Se√±ales hidr√°ulicas",
                    "Se√±ales electr√≥nicas de la ECU",
                    "Se√±ales neum√°ticas"
                ],
                answer: 2
            },
            {
                category: "inyector",
                question: "¬øQu√© problema puede causar un inyector sucio o obstruido?",
                options: [
                    "Mayor consumo de combustible",
                    "Ralent√≠ irregular y fallos de encendido",
                    "Sobrecalentamiento del motor",
                    "P√©rdida de presi√≥n de aceite"
                ],
                answer: 1
            },
            {
                category: "inyector",
                question: "¬øQu√© mide el tiempo de inyecci√≥n?",
                options: [
                    "La presi√≥n del combustible",
                    "El tiempo que permanece abierto el inyector",
                    "La temperatura del motor",
                    "La velocidad del veh√≠culo"
                ],
                answer: 1
            },
            {
                category: "inyector",
                question: "¬øQu√© es el cono de pulverizaci√≥n en un inyector?",
                options: [
                    "La forma que adopta el combustible al ser inyectado",
                    "La parte c√≥nica del cuerpo del inyector",
                    "Un dispositivo para medir el flujo",
                    "Un tipo de filtro c√≥nico"
                ],
                answer: 0
            },
            {
                category: "inyector",
                question: "¬øQu√© sistema de inyecci√≥n es m√°s eficiente?",
                options: [
                    "Inyecci√≥n directa",
                    "Inyecci√≥n indirecta",
                    "Inyecci√≥n secuencial",
                    "Inyecci√≥n m√∫ltiple"
                ],
                answer: 0
            },
            {
                category: "inyector",
                question: "¬øQu√© ocurre cuando un inyector gotea?",
                options: [
                    "Mejora el rendimiento del motor",
                    "Puede causar encendido irregular despu√©s de apagar el motor",
                    "Aumenta la compresi√≥n del motor",
                    "Mejora la emisi√≥n de gases"
                ],
                answer: 1
            },
            {
                category: "inyector",
                question: "¬øQu√© herramienta se utiliza para limpiar inyectores fuera del motor?",
                options: [
                    "Una m√°quina de ultrasonido",
                    "Una pulidora neum√°tica",
                    "Un desarmador especial",
                    "Una lijadora orbital"
                ],
                answer: 0
            },
            {
                category: "inyector",
                question: "¬øQu√© sintoma presentar√≠a un veh√≠culo con inyectores obstruidos?",
                options: [
                    "Aceleraci√≥n suave y respuesta inmediata",
                    "Dificultad al arrancar y fallos en el ralent√≠",
                    "Aumento de potencia a altas revoluciones",
                    "Disminuci√≥n del consumo de combustible"
                ],
                answer: 1
            },
            {
                category: "inyector",
                question: "¬øQu√© mide la prueba de balance de inyectores?",
                options: [
                    "La compresi√≥n de cada cilindro",
                    "El flujo de combustible de cada inyector",
                    "La temperatura de escape",
                    "La presi√≥n de aceite"
                ],
                answer: 1
            }
        ];

        let userAnswers = Array(questions.length).fill(null);
        let currentQuestion = 0;
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        
        // Inicializar el cuestionario
        function initQuiz() {
            showQuestion();
            updateProgressBar();
        }
        
        // Mostrar la pregunta actual
        function showQuestion() {
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = '';
            
            // Agrupar preguntas por categor√≠a
            const bombaQuestions = questions.filter(q => q.category === "bomba");
            const inyectorQuestions = questions.filter(q => q.category === "inyector");
            
            // Mostrar t√≠tulo de categor√≠a
            const categoryTitle = document.createElement('div');
            categoryTitle.className = 'category-title';
            
            const icon = document.createElement('span');
            icon.className = 'category-icon';
            icon.innerHTML = currentQuestion < 10 ? '‚õΩ' : 'üîß';
            
            const title = document.createElement('h2');
            title.textContent = currentQuestion < 10 ? 'Bomba de Combustible' : 'Inyectores';
            
            categoryTitle.appendChild(icon);
            categoryTitle.appendChild(title);
            quizContainer.appendChild(categoryTitle);
            
            // Mostrar pregunta actual
            const questionElement = document.createElement('div');
            questionElement.className = 'question';
            
            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.innerHTML = `<span style="font-weight: bold;">Pregunta ${currentQuestion + 1}/20:</span> ${questions[currentQuestion].question}`;
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options';
            
            questions[currentQuestion].options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                if (userAnswers[currentQuestion] === index) {
                    optionElement.classList.add('selected');
                }
                optionElement.textContent = option;
                optionElement.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionElement);
            });
            
            questionElement.appendChild(questionText);
            questionElement.appendChild(optionsContainer);
            quizContainer.appendChild(questionElement);
            
            // Botones de navegaci√≥n
            const navButtons = document.createElement('div');
            navButtons.style.display = 'flex';
            navButtons.style.justifyContent = 'space-between';
            navButtons.style.marginTop = '20px';
            
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = currentQuestion === 0;
            prevButton.onclick = () => {
                currentQuestion--;
                showQuestion();
                updateProgressBar();
            };
            
            const nextButton = document.createElement('button');
            nextButton.textContent = currentQuestion === questions.length - 1 ? 'Finalizar' : 'Siguiente';
            nextButton.onclick = () => {
                if (userAnswers[currentQuestion] === null) {
                    alert('Por favor selecciona una respuesta');
                    return;
                }
                
                if (currentQuestion < questions.length - 1) {
                    currentQuestion++;
                    showQuestion();
                    updateProgressBar();
                } else {
                    calculateResults();
                }
            };
            
            navButtons.appendChild(prevButton);
            navButtons.appendChild(nextButton);
            quizContainer.appendChild(navButtons);
        }
        
        // Seleccionar una opci√≥n
        function selectOption(index) {
            userAnswers[currentQuestion] = index;
            showQuestion();
        }
        
        // Actualizar barra de progreso
        function updateProgressBar() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        // Calcular resultados
        function calculateResults() {
            let bombaCorrect = 0;
            let inyectorCorrect = 0;
            
            questions.forEach((question, index) => {
                if (userAnswers[index] === question.answer) {
                    if (question.category === "bomba") {
                        bombaCorrect++;
                    } else {
                        inyectorCorrect++;
                    }
                }
            });
            
            document.getElementById('bombaScore').textContent = bombaCorrect;
            document.getElementById('inyectorScore').textContent = inyectorCorrect;
            
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.style.display = 'block';
            
            const systemStatus = document.getElementById('systemStatus');
            
            if (bombaCorrect >= 8 && inyectorCorrect >= 8) {
                systemStatus.textContent = 'SISTEMA ACTIVADO - ¬°Condiciones cumplidas!';
                systemStatus.className = 'system-status success';
                document.getElementById('sendCommandBtn').disabled = false;
            } else {
                systemStatus.textContent = 'SISTEMA NO ACTIVADO - No cumples con los requisitos m√≠nimos';
                systemStatus.className = 'system-status failure';
                document.getElementById('sendCommandBtn').disabled = true;
            }
            
            // Desplazarse a los resultados
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Conectar Bluetooth
        async function connectBluetooth() {
            try {
                console.log('Solicitando dispositivo Bluetooth...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'ESP32' },
                        { services: ['battery_service'] }
                    ],
                    optionalServices: ['generic_access', '0000ffe0-0000-1000-8000-00805f9b34fb']
                });
                
                bluetoothDevice = device;
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connectionText').textContent = `Conectado a: ${device.name}`;
                
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                console.log('Conectando al servidor GATT...');
                const server = await device.gatt.connect();
                
                console.log('Obteniendo servicio...');
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                
                console.log('Obteniendo caracter√≠stica...');
                const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                
                bluetoothCharacteristic = characteristic;
                
                console.log('Conexi√≥n Bluetooth establecida correctamente');
                
            } catch (error) {
                console.error('Error de conexi√≥n Bluetooth:', error);
                alert('Error al conectar con el dispositivo: ' + error.message);
            }
        }
        
        // Manejar desconexi√≥n
        function onDisconnected() {
            console.log('Dispositivo Bluetooth desconectado');
            document.getElementById('statusDot').classList.remove('connected');
            document.getElementById('connectionText').textContent = 'Desconectado del ESP32';
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
        }
        
        // Enviar comando al ESP32
        async function sendCommand() {
            if (!bluetoothCharacteristic) {
                alert('Primero debes conectar con el ESP32');
                return;
            }
            
            try {
                // Obtener resultados
                let bombaCorrect = 0;
                let inyectorCorrect = 0;
                
                questions.forEach((question, index) => {
                    if (userAnswers[index] === question.answer) {
                        if (question.category === "bomba") {
                            bombaCorrect++;
                        } else {
                            inyectorCorrect++;
                        }
                    }
                });
                
                // Determinar comando a enviar
                let command;
                if (bombaCorrect >= 8 && inyectorCorrect >= 8) {
                    command = 1; // Encender
                    alert('¬°Comando de activaci√≥n enviado! El sistema se encender√°.');
                } else {
                    command = 0; // Apagar
                    alert('Comando de desactivaci√≥n enviado. El sistema permanecer√° apagado.');
                }
                
                // Convertir el comando a un array de bytes y enviarlo
                const data = new Uint8Array([command]);
                await bluetoothCharacteristic.writeValue(data);
                
                console.log('Comando enviado correctamente:', command);
                
            } catch (error) {
                console.error('Error al enviar comando:', error);
                alert('Error al enviar comando: ' + error.message);
            }
        }
        
        // Inicializar la aplicaci√≥n cuando se cargue la p√°gina
        window.onload = initQuiz;
    </script>
</body>
</html>
